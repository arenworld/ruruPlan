<!DOCTYPE html>
<html  class="responsive-login-page" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">

    <title>회원가입 폼</title>
    <link rel="stylesheet" th:href="@{/css/rurustyle.css}">
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
            crossorigin="anonymous"
    />
    <link rel="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
    <style>
        i{
            position: absolute;
            left: 90%;
            top: 45px;
            color: black;
        }
    </style>
    <script src="https://kit.fontawesome.com/0efaee6f1c.js" crossorigin="anonymous"></script>
    <script src="/js/jquery-3.4.1.min.js"></script>
    <script>
        $(document).ready(function() {
            //비밀번호 노출,숨기기 기능
            $('.input-group i').on('click',function(){
                $('#memberPw').toggleClass('active');
                if($('input').hasClass('active')){
                    $(this).attr('class', "fa-solid fa-eye")
                        .prev('input').attr('type', "text");
                }else{
                    $(this).attr('class',"fa-solid fa-eye")
                        .prev('input').attr('type','password');
                }
            });
            //모달창 열기
            $('.agree').on('click', function(event) {
                event.preventDefault();
                $('.terms').addClass('open'); // terms 모달 창 열기
                $('.modal-backdrop').addClass('open'); // 배경 활성화
            });

            // 모달 닫기
            $('.modal-backdrop').on('click', function() {
                $('.terms').removeClass('open'); // terms 모달 창 닫기
                $('.modal-backdrop').removeClass('open'); // 배경 비활성화
            });

            // 아이디 유효성 검사
            $('#memberId').keyup(idConfirm);
            // 닉네임
            $('#nickname').keyup(nicknameConfirm);
            // 비밀번호 유효성 검사
            $('#memberPw').keyup(validatePw);
            // 비밀번호 대조,확인
            $('#pwConfirm').keyup(pwConfirm);
            //이메일 형식/ 중복 검사
            $('#email').keyup(validateEmail);
            //이메일 인증번호
            $('#emCodeBt').click(emConfirm);

            //회원가입 폼제출시 검사
            $('.login-form').on('submit', function(event) {
                alert("왈왈멍ㅁ어 왜 안돼는 거야")
                if (!formConfirm()) { //얘도 안됨...
                    event.preventDefault();  // 폼 제출 막기
                    alert('모든 입력 값을 올바르게 입력해주세요.');
                    return false;
                }
                return false; //얘가 안됨...
            });

        });

        // 아이디 유효성 겁사
        function idConfirm(){
            //정규식   (문자열, 영어(필수)+숫자(선택) 6~15자, 대소문자 구분)
            id_regex = /^(?=.*[a-zA-Z])[a-zA-Z0-9]{6,15}$/;
            let id = $(this).val();

            /*아이디 형식 확인*/
            if (!id_regex.test(id)) {
                $('#idmsg').css('color', 'red');
                $('#idmsg').html('아이디는 영문,숫자로 6~15글자 입력해 주세요');
                return false;
            } else {
                let valid = false;
           /*아이디 중복확인*/
                $.ajax({
                    url: 'idDuplicate',
                    type: 'post',
                    data: {id: id},
                    success: function (res) {
                        if (res) {
                            $('#idmsg').css('color', 'red');
                            $('#idmsg').html("이미 사용중인 ID입니다");
                            valid = false;
                        } else {
                            $('#idmsg').css('color', 'blue');
                            $('#idmsg').html("사용가능한 ID입니다.");
                            valid = true;
                        }
                    },
                    error: function () {
                        alert('IdDuplicate error');
                        valid = false;
                    }
                });
                return valid;
            }
        }

        // 닉네임 유효성 검사
        function nicknameConfirm(){
            //정규식 (영문/항글/숫자 2~10자, 대소문자 구분)
            nickname_regex = /^[A-Za-z가-힣0-9]{2,10}$/;
            let nickname = $(this).val();

            if (!nickname_regex.test(nickname)) {
                $('#nicknamemsg').css('color', 'red');
                $('#nicknamemsg').html('닉네임은 영문,한글,숫자로 1~10글자 입력해 주세요');
                return false;
            } else {
                $('#nicknamemsg').css('color', 'blue');
                $('#nicknamemsg').html('사용 가능한 닉네임입니다.');
                return true;
            }
        }

        // 비밀번호 유효성 검사
        function validatePw() {
            //비밀번호 정규표현식(영문/숫자/특수문자를 1자 이상 포함 8~15자, 대소문자 구분)
            pw_regex = /^(?=.*[a-zA-Z])(?=.*\d)(?=.*[~!@#$%^&*_\-+=`|\\(){}[\]:;"'<>,.?/])[a-zA-Z\d~!@#$%^&*_\-+=`|\\(){}[\]:;"'<>,.?/]{8,15}$/;
            let pw = $('#memberPw').val();

            if (!pw_regex.test(pw)) {
                $('#pwmsg1').css('color', 'red');
                $('#pwmsg1').css('font-size', '12px');
                $('#pwmsg1').html('영문/숫자/특수문자를 1자 이상 포함한 8~15자로 입력');
                return false;
            } else {
                $('#pwmsg1').html("");
                return true;
            }
            }

        // 비밀번호 일치 확인
        function pwConfirm(){
            let pwConfirm = $(this).val();
            let pw = $('#memberPw').val();

            console.log(pwConfirm, pw);

            if(pwConfirm == pw){
                $('#pwmsg').css('color', 'green');
                $('#pwmsg').html("비밀번호 일치");
                return true;
            } else {
                $('#pwmsg').css('color', 'red');
                $('#pwmsg').html("비밀번호가 일치하지 않습니다.");
                return false;
            }
        }

        //이메일 유효성 검사 (형식+중복확인)
        function validateEmail() {
            //이메일 정규표현식
            email_regex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/i;
            let email = $('#email').val();

            if (!email_regex.test(email)) {
                $('#emailmsg').css('color', 'red');
                $('#emailmsg').html("유효하지 않은 이메일 주소입니다.");
                $('#emCodeBt').prop('disabled', true);
                return false;
            } else {
                // 중복 검사
                let valid = false;
                $.ajax({
                    url: 'emailDuplicate',
                    type: 'post',
                    data: {email: email},
                    success: function (res) {
                        if (res) {
                            $('#emailmsg').css('color', 'red');
                            $('#emailmsg').html("이미 사용중인 email입니다");
                            $('#emCodeBt').prop('disabled', true);
                            valid = false;
                        } else {
                            $('#emailmsg').css('color', 'black');
                            $('#emailmsg').html("사용 가능");
                            $('#emCodeBt').prop('disabled', false);
                            valid = true;
                        }
                    },
                    error: function () {
                        alert('EmailDuplicate error');
                        valid = false;
                    }
                });
                return valid;
            }

        }

        // 이메일 인증 번호 전송
        function emConfirm(){
            let email = $('#email').val();

            $.ajax({
                url: 'mailConfirm',
                type: 'post',
                data: {email: email},
                success: function (code) {
                    if (code) {
                        alert("이메일이 전송되었습니다." +
                            "인증번호 확인 후 입력해주세요.")
                        chkEmailConfirm(code);
                    }
                },
                error: function () {
                    alert("이메일 전송에 실패하였습니다.")
                }
            });
        }
        // 이메일 인증 번호 확인
        function chkEmailConfirm(code){
            $('#emailconfirm').on("keyup", function(){
                if (code != $('#emailconfirm').val()) {
                    emconfirmchk = false;
                    $('#emchkmsg').html("<span id='emconfirmchk'>인증번호가 잘못되었습니다</span>")
                    $("#emconfirmchk").css({
                        "color" : "#FA3E3E",
                        "font-weight" : "bold",
                        "font-size" : "10px"
                    }
                    )
                    return emconfirmchk;
                } else {
                    emconfirmchk = true;
                    $('#emchkmsg').html("<span id='emconfirmchk'>인증번호 확인 완료</span>")
                    $("#emconfirmchk").css({
                        "color" : "#0D6EFD",
                        "font-weight" : "bold",
                        "font-size" : "10px"
                    })
                    return emconfirmchk;
                }
            })
        }

        //회원가입 폼 제출 내용 확인
        function formConfirm(){
            // 아이디 유효성 검사
            let idValid = idConfirm();
            // 비밀번호 유형성 검사
            let pwValid = validatePw();
            // 비밀번호 재입력 일치 확인
            let pwConfirmValid = pwConfirm();
            // 닉네임 유효성 검사
            let nicknameValid = nicknameConfirm();
            //이메일 유효성 검사
            let validateEmail = validateEmail();
            // 이메일 인증번호 확인
            let emailValid = emconfirmchk;

            console.log("유효성 검사 {}, {}, {}, {}, {}, {}", idValid, pwValid, pwConfirmValid, nicknameValid,validateEmail, emailValid);
            if (!idValid || !nicknameValid || !pwValid || !pwConfirmValid || !emailValid || !validateEmail || !emconfirmchk) {
                return false;
            }
            return true;
        }
    </script>
</head>
<body class="responsive-login-page">
    <div class="logo-title">
        <img class="logo" src="images/화면 캡처 2024-09-01 125210.png" />
      <p>ソウルに触る</p>
    </div>
    <div class="responsive-frame">
        <main>
    <p class="main-title">会員登録</p>
<!--    &lt;!&ndash; 개잊정보 약관 &ndash;&gt;
    <div class="terms">
     <h2>dp Terms of Service</h2>
         <p class="small">개인정보 처리 약관 내용</p>
    </div>-->
    <!-- 회원가입 양식 -->
    <form class="login-form" th:action="@{/join}" th:method="post">
        <div class="input-group">
        <!--아이디-->
      <label for="memberId"  class="input-label">ID</label>
        <input type="text" name="memberId" id="memberId" placeholder="ID" required>
        <span id="idmsg" ></span>
        </div>
        <!-- 비밀번호 -->
        <div class="input-group">
        <label for="memberPw"  class="input-label">Password</label>
        <input type="password" name="memberPw" id="memberPw" placeholder="&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;" required>
            <i class="fa-solid fa-eye"></i>
            <span id="pwmsg1"></span>
        </div>
        <!--비밀번호 확인-->
        <div class="input-group">
        <label for="pwConfirm" class="input-label">Password Confirm</label>
        <input type="password" id="pwConfirm" required>
            <span id="pwmsg"></span>
        </div>
        <!--닉네임-->
        <div class="input-group">
        <label for="nickname" class="input-label">Nickname</label>
        <input type="text" name="nickname" id="nickname" placeholder="Nickname" required>
            <span id="nicknamemsg"></span>
        </div>
        <!--연령대-->
        <div class="input-group">
        <label for="age" class="input-label">Age</label>
            <select id="age" name="age" ckass="input=select" required>
                <option value="">Age</option>
                <option value="10">10대</option>
                <option value="20">20대</option>
                <option value="30">30대</option>
                <option value="40">40대</option>
                <option value="50">50대</option>
                <option value="60">60대</option>
            </select>
        </div>
        <div class="input-group">
      <label for="email" class="input-label">Email</label>
        <input type="email" name="email" id="email" placeholder="Email" required>
        <input type="button" id="emCodeBt" value="認証" disabled="disabled">
            <span id="emailmsg"></span>
        </div>
        <div class="form-group last mb-4 check_input">
            <input type="text" class="form-control" id="emailconfirm" placeholder="인증번호를 입력해주세요" required>
            <span id="emchkmsg"></span>
        </div>
        <div class="box-clause-round">
            <div class="clause-item">
      <input type="checkbox" id="agree" required>
     <label for="agree">I agree to the <i class="fa fa-arrow-left"  aria-hidden="true"></i><a class="agree" href="#">Terms of service</a></label>
            </div>
        </div>
                <div id="form-controls">
                    <button type="submit" id="submit">Sign Up</button>
     </div>
    </form>
        </main>
    </div>
</body>
</html>
